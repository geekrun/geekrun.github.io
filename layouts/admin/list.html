{{/*
  Custom admin page with password gate and Decap CMS loader.
  Password hash is provided via HUGO environment variable ADMIN_PASSWORD_SHA256.
*/}}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; display: grid; place-items: center; min-height: 100dvh; }
      .card { width: min(480px, 92vw); padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,.08); background: var(--card-bg, #fff); }
      h1 { font-size: 20px; margin: 0 0 12px; }
      p { margin: 6px 0 16px; opacity: .8; }
      input[type="password"], input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,.15); font-size: 14px; }
      button { margin-top: 12px; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: #111827; color: #fff; font-weight: 600; cursor: pointer; }
      .hint { font-size: 12px; opacity: .65; margin-top: 8px; }
      .error { color: #b91c1c; font-size: 13px; margin-top: 8px; display: none; }
      .hidden { display: none; }
      .cms-root { width: 100%; height: 100dvh; }
    </style>
  </head>
  <body>
    <div id="gate" class="card">
      <h1>Admin Sign-in</h1>
      <p>Enter the admin password to continue.</p>
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="unlock">Unlock</button>
      <div id="error" class="error">Incorrect password</div>
      <div class="hint">Tip: the password is configured as an environment variable on Vercel.</div>
    </div>

    <div id="cms" class="cms-root hidden"></div>
    <div id="status" class="hint" style="position:fixed;left:12px;bottom:12px"></div>

    <script>
      // Read from Hugo environment variables (whitelisted prefix HUGO_)
      const ADMIN_PASSWORD_SHA256 = "{{ getenv "HUGO_PARAMS_ADMIN_PASSWORD_SHA256" }}";
      const USE_SESSION = {{ if eq (getenv "HUGO_PARAMS_ADMIN_PASSWORD_PERSIST") "local" }}false{{ else }}true{{ end }};
      const OAUTH_BASE_URL = "{{ getenv "HUGO_PARAMS_OAUTH_BASE_URL" }}" || "https://your-oauth-app.vercel.app";

      function sha256Hex(str) {
        const enc = new TextEncoder().encode(str);
        return crypto.subtle.digest('SHA-256', enc).then(buf =>
          Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('')
        );
      }

      function getStoredHash() {
        try {
          const key = 'admin_pw_sha256';
          return (USE_SESSION ? sessionStorage.getItem(key) : localStorage.getItem(key)) || '';
        } catch { return ''; }
      }

      function setStoredHash(hash) {
        try {
          const key = 'admin_pw_sha256';
          (USE_SESSION ? sessionStorage : localStorage).setItem(key, hash);
        } catch {}
      }

      async function isAuthed() {
        if (!ADMIN_PASSWORD_SHA256) return true; // if not configured, allow
        const saved = getStoredHash();
        return saved && saved === ADMIN_PASSWORD_SHA256;
      }

      function setStatus(msg) { try { document.getElementById('status').textContent = msg; } catch {}
      }

      function loadScript(src, cb, onErr) {
        const s = document.createElement('script');
        s.src = src;
        s.onload = cb;
        s.onerror = onErr;
        document.body.appendChild(s);
      }

      function loadCMS() {
        const gate = document.getElementById('gate');
        const cms = document.getElementById('cms');
        gate.classList.add('hidden');
        cms.classList.remove('hidden');
        // Tell Decap we will initialize manually with a JS config
        window.CMS_MANUAL_INIT = true;
        setStatus('Loading CMS...');
        const init = () => {
          try {
            if (!(window.CMS && typeof window.CMS.init === 'function')) throw new Error('CMS.init unavailable');
            const decapConfig = {
              backend: {
                name: 'github',
                repo: 'geekrun/geekrun.github.io',
                branch: 'master',
                base_url: OAUTH_BASE_URL,
                auth_endpoint: '/auth',
              },
              media_folder: 'static/images/uploads',
              public_folder: '/images/uploads',
              publish_mode: 'simple',
              collections: [
                {
                  name: 'posts',
                  label: 'Posts',
                  folder: 'content/posts',
                  create: true,
                  slug: '{{ "{{year}}" }}-{{ "{{month}}" }}-{{ "{{day}}" }}-{{ "{{slug}}" }}',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Date', name: 'date', widget: 'datetime' },
                    { label: 'Draft', name: 'draft', widget: 'boolean', default: true },
                    { label: 'Description', name: 'description', widget: 'text', required: false },
                    { label: 'Tags', name: 'tags', widget: 'list', required: false },
                    { label: 'Categories', name: 'categories', widget: 'list', required: false },
                    { label: 'Cover', name: 'cover', widget: 'image', required: false },
                    { label: 'Body', name: 'body', widget: 'markdown' },
                  ],
                },
                {
                  name: 'pages',
                  label: 'Pages',
                  files: [
                    {
                      label: 'About',
                      name: 'about',
                      file: 'content/about/_index.md',
                      fields: [
                        { label: 'Title', name: 'title', widget: 'string' },
                        { label: 'Body', name: 'body', widget: 'markdown' },
                      ],
                    },
                  ],
                },
              ],
            };
            window.CMS.init({ config: decapConfig });
            setStatus('CMS loaded');
          } catch (e) {
            console.error(e);
            setStatus('CMS init failed');
            alert('CMS 初始化失败：' + e.message);
          }
        };
        // Force manual init only (avoid auto YAML discovery)
        window.CMS_CONFIG = undefined;
        loadScript('https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js', init, () => {
          setStatus('unpkg failed, trying jsdelivr...');
          loadScript('https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js', init, () => {
            setStatus('Failed to load CMS from CDNs');
            alert('无法加载 Decap CMS 脚本，请检查网络或 CSP');
          });
        });
      }

      async function tryUnlock() {
        const error = document.getElementById('error');
        error.style.display = 'none';
        if (!ADMIN_PASSWORD_SHA256) { loadCMS(); return; }
        const input = document.getElementById('password');
        const hash = await sha256Hex(input.value || '');
        if (hash === ADMIN_PASSWORD_SHA256) {
          setStoredHash(hash);
          loadCMS();
        } else {
          error.style.display = 'block';
        }
      }

      document.getElementById('unlock').addEventListener('click', tryUnlock);
      document.getElementById('password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') tryUnlock();
      });

      (async () => { if (await isAuthed()) loadCMS(); })();
    </script>
  </body>
  </html>


